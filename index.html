<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML Tutorial</title>
</head>
<body>

  <h1>Hi</h1>
  <p>Hello</p>

  <h2>Try</h2>
  <p>
    <a href="https://tannyfolio.pages.dev">
      This is a link I think hehe.
    </a>
  </p>

  <h1>Final Test</h1>
<h1><strong>markcomplete.js</strong></h1>
<code><pre>
require('dotenv').config();
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const { google } = require('googleapis');
const querystring = require('querystring');

// --- üõ°Ô∏è CONFIGURATION ---
const SCAN_MONTHS_BACK = 6; // Scan back enough to cover Oct 22
const START_DATE_STR = "2025-10-22"; // üìÖ START CHECKING FROM THIS DATE
const TOKEN_PATH = path.join(__dirname, 'zoom_token.json');
const LOG_PATH = path.join(__dirname, 'completed_log.json');
const REPORT_PATH = path.join(__dirname, 'missing_report.txt');

// üõí SALES TEAM
const SALES_TEAM_FOLDERS = {
    "yoshi@ecommerceequation.com.au": "1i-1JcXYriROX05FJ1vq-Si9p885cYdnh",
    "shant@ecommerceequation.com.au": "1HKQN41WjsOay2oQTPLeDlooZRi0jqRsf",
    "jaket@ecommerceequation.com.au": "1UPVHx1DpeooUi6bnoKwNa0tPPXsWDV9M",
    "seanb@ecommerceequation.com.au": "1PQ_Bm3wkVXYMHPSVhoOb1AoQFQ23JwHS"
};

// üö´ IGNORE LISTS
const IGNORE_EMAILS = [
    "jw@jaywright.com.au", "finance@ecommerceequation.com.au", "jake@ecommerceequation.com.au",
    "kelsey@ecommerceequation.com.au", "lisa@ecommerceequation.com.au", "bel@ecommerceequation.com.au",
    "emilie@ecommerceequation.com.au", "carlos@ecommerceequation.com.au", "jiah@ecommerceequation.com.au",
    "arthur@ecommerceequation.com.au", "luiza@ecommerceequation.com.au", "geneca@ecommerceequation.com.au",
    "andres@ecommerceequation.com.au", "will@ecommerceequation.com.au", "michelles@ecommerceequation.com.au",
    "kimberley@ecommerceequation.com.au", "elizabeth@ecommerceequation.com.au", "ella@ecommerceequation.com.au",
    "kieren@ecommerceequation.com.au", "paige@ecommerceequation.com.au", "thelab@ecommerceequation.com.au",
    "kit@ecommerceequation.com.au", "ernie@ecommerceequation.com.au", "reece@ecommerceequation.com.au",
    "zahrah@ecommerceequation.com.au", "esteban@ecommerceequation.com.au", "mia@ecommerceequation.com.au",
    "admin@ecommerceequation.com.au", "norma@ecommerceequation.com.au", "edel@ecommerceequation.com.au",
    "geralde@ecommerceequation.com.au", "linda@ecommerceequation.com.au", "madisongracewhite@gmail.com",
    "noah@ecommerceequation.com.au", "hayden@ecommerceequation.com.au", "jeff@ecommerceequation.com.au",
    "kingsley@ecommerceequation.com.au", "sooji@ecommerceequation.com.au", "brendan@ecommerceequation.com.au",
    "benjamin@ecommerceequation.com.au", "dan@ecommerceequation.com.au", "michelle@ecommerceequation.com.au",
    "kye@ecommerceequation.com.au", "jasmynn@ecommerceequation.com.au", "neil@ecommerceequation.com.au",
    "nigel@ecommerceequation.com.au", "matt@ecommerceequation.com.au", "theodore@ecommerceequation.com.au",
    "chantel@ecommerceequation.com.au", "kate@ecommerceequation.com.au", "ali@ecommerceequation.com.au",
    "joss@ecommerceequation.com.au", "stevie@ecommerceequation.com.au", "johann@ecommerceequation.com.au",
    "jen@ecommerceequation.com.au"
];

let FIELD_MAP = { internal: null, member: null };
let CLICKUP_CACHE = [];
let missingList = []; 

// --- HELPERS ---
function getFormattedDate(dateString) {
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const d = new Date(dateString);
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

// üíæ HELPER: Safe Save to JSON
function saveToLog(newData) {
    let currentLog = [];
    if (fs.existsSync(LOG_PATH)) {
        try { currentLog = JSON.parse(fs.readFileSync(LOG_PATH)); } catch (e) { currentLog = []; }
    }
    // Update if exists, or push new
    const index = currentLog.findIndex(item => item.uuid === newData.uuid);
    if (index !== -1) {
        currentLog[index] = newData; // Update existing
    } else {
        currentLog.push(newData); // Add new
    }
    fs.writeFileSync(LOG_PATH, JSON.stringify(currentLog, null, 2));
}

async function getZoomAccessToken() {
    if (!fs.existsSync(TOKEN_PATH)) throw new Error("‚ùå No Token Found!");
    let tokenData = JSON.parse(fs.readFileSync(TOKEN_PATH));
    if (Date.now() >= tokenData.expires_at) {
        console.log('üîÑ Refreshing Zoom Token...');
        const credentials = Buffer.from(`${process.env.ZOOM_CLIENT_ID}:${process.env.ZOOM_CLIENT_SECRET}`).toString('base64');
        const res = await axios.post('https://zoom.us/oauth/token', querystring.stringify({ grant_type: 'refresh_token', refresh_token: tokenData.refresh_token }), { headers: { 'Authorization': `Basic ${credentials}`, 'Content-Type': 'application/x-www-form-urlencoded' } });
        tokenData = { access_token: res.data.access_token, refresh_token: res.data.refresh_token, expires_at: Date.now() + (res.data.expires_in * 1000) - 5000 };
        fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokenData));
    }
    return tokenData.access_token;
}

// üè∑Ô∏è RENAME ZOOM
async function markZoomComplete(meetingId, currentTopic, token) {
    if (currentTopic.includes('‚úÖ')) return; 
    try {
        const safeId = encodeURIComponent(meetingId);
        const newTopic = `${currentTopic} ‚úÖ`;
        await axios.patch(`https://api.zoom.us/v2/meetings/${safeId}`, { topic: newTopic }, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
    } catch (e) {
        if (e.response && e.response.status === 404) {
             try {
                const doubleId = encodeURIComponent(encodeURIComponent(meetingId));
                await axios.patch(`https://api.zoom.us/v2/meetings/${doubleId}`, { topic: `${currentTopic} ‚úÖ` }, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
             } catch(err2) {}
        }
    }
}

async function refreshClickUpCache() {
    if (!process.env.CLICKUP_LIST_ID || !process.env.CLICKUP_API_KEY) return;
    console.log("üì• Loading ClickUp Database...");
    if (!FIELD_MAP.internal) {
        const res = await axios.get(`https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/field`, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
        FIELD_MAP.internal = res.data.fields.find(f => f.name === process.env.CLICKUP_INTERNAL_COL_NAME)?.id;
        FIELD_MAP.member = res.data.fields.find(f => f.name === process.env.CLICKUP_MEMBER_COL_NAME)?.id;
    }
    let page = 0, keepGoing = true;
    while (keepGoing) {
        try {
            const res = await axios.get(`https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true&page=${page}`, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
            if (!res.data.tasks || res.data.tasks.length === 0) keepGoing = false;
            else {
                CLICKUP_CACHE = CLICKUP_CACHE.concat(res.data.tasks.map(t => ({ n: t.name.trim().toLowerCase(), m: t.custom_fields.find(f => f.id === FIELD_MAP.member)?.value, i: t.custom_fields.find(f => f.id === FIELD_MAP.internal)?.value })));
                process.stdout.write(`   Page ${page} loaded...\r`);
                page++;
            }
        } catch (e) { keepGoing = false; }
    }
    console.log(`\n‚úÖ ClickUp Loaded: ${CLICKUP_CACHE.length} Brands.`);
}

function getFolderIds(brandName) {
    const task = CLICKUP_CACHE.find(t => t.n === brandName.trim().toLowerCase());
    if (!task) return null;
    const extractId = (link) => {
        if (!link) return null;
        if (link.includes('id=')) return link.split('id=')[1].split('?')[0];
        const parts = link.split('/');
        return parts[parts.length - 1] || parts[parts.length - 2];
    };
    return { internal: extractId(task.i), member: extractId(task.m) };
}

// üîç DRIVE CHECKER
async function verifyInDrive(isSales, topic, dateStr, salesParentId, brandIds) {
    const oauth2Client = new google.auth.OAuth2(process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET, "http://localhost");
    oauth2Client.setCredentials({ refresh_token: process.env.GOOGLE_REFRESH_TOKEN });
    const drive = google.drive({ version: 'v3', auth: oauth2Client });

    try {
        let cleanTopic = topic.includes("Scale Session") ? topic.replace("Scale Session", "").trim() : topic;
        const safeDate = dateStr.replace(/'/g, "\\'");
        
        if (isSales) {
            const safeName = topic.replace(/'/g, "\\'");
            const folderQuery = `mimeType = 'application/vnd.google-apps.folder' and '${salesParentId}' in parents and name = '${safeName}' and trashed = false`;
            const folderRes = await drive.files.list({ q: folderQuery, fields: 'files(id)', supportsAllDrives: true, includeItemsFromAllDrives: true });
            if (!folderRes.data.files || folderRes.data.files.length === 0) return false;
            
            const specificFolderId = folderRes.data.files[0].id;
            const fileQuery = `'${specificFolderId}' in parents and name contains '${safeName}' and name contains '${safeDate}' and trashed = false`;
            const fileRes = await drive.files.list({ q: fileQuery, fields: 'files(id)', supportsAllDrives: true, includeItemsFromAllDrives: true });
            return fileRes.data.files.length > 0;
        } else {
            if (!brandIds) return false;
            const part1 = cleanTopic.split(' x ')[0].trim().replace(/'/g, "\\'");
            
            let parentQuery = "";
            if (brandIds.internal && brandIds.member) parentQuery = `('${brandIds.internal}' in parents or '${brandIds.member}' in parents)`;
            else if (brandIds.internal) parentQuery = `'${brandIds.internal}' in parents`;
            else if (brandIds.member) parentQuery = `'${brandIds.member}' in parents`;
            else return false;

            const query = `${parentQuery} and name contains '${part1}' and name contains '${safeDate}' and trashed = false`;
            const res = await drive.files.list({ q: query, fields: 'files(id)', supportsAllDrives: true, includeItemsFromAllDrives: true });
            return res.data.files.length > 0;
        }
    } catch (e) { return false; }
}

// --- MAIN SCRIPT ---
async function syncHistory() {
    try {
        console.log(`üïµÔ∏è STARTING RE-ARCHITECTED SYNC...`);
        console.log(`üìÖ TARGET RANGE: ${START_DATE_STR} to TODAY`);
        console.log(`   (Older videos will be ignored)`);
        
        await refreshClickUpCache();
        const token = await getZoomAccessToken();
        
        const usersRes = await axios.get('https://api.zoom.us/v2/users?page_size=300', { headers: { 'Authorization': `Bearer ${token}` } });
        const users = usersRes.data.users || [];

        let counter = 0;
        let foundCount = 0;
        const startCheckTime = new Date(START_DATE_STR).getTime(); // Oct 22 Timestamp

        for (const user of users) {
            for (let i = 0; i < SCAN_MONTHS_BACK; i++) {
                let toDate = new Date(); toDate.setMonth(toDate.getMonth() - i);
                let fromDate = new Date(); fromDate.setMonth(fromDate.getMonth() - (i + 1));
                const toStr = toDate.toISOString().split('T')[0];
                const fromStr = fromDate.toISOString().split('T')[0];

                try {
                    const res = await axios.get(`https://api.zoom.us/v2/users/${user.id}/recordings?from=${fromStr}&to=${toStr}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!res.data.meetings) continue;

                    for (const meeting of res.data.meetings) {
                        const meetingTime = new Date(meeting.start_time).getTime();
                        const niceDate = getFormattedDate(meeting.start_time);

                        // üõë DATE START CHECK
                        // If Meeting is OLDER (Less) than Start Date -> SKIP
                        if (meetingTime < startCheckTime) {
                            // console.log(`   ‚è≠Ô∏è Skipped (Too Old): "${meeting.topic}" (${niceDate})`);
                            continue;
                        }

                        counter++;

                        // üèóÔ∏è DATA OBJECT
                        const videoData = {
                            name: meeting.topic,
                            uuid: meeting.uuid,
                            date: niceDate,
                            link: meeting.share_url,
                            status: "Pending"
                        };

                        // 1. üü¢ CHECK: IGNORED EMAILS
                        if (IGNORE_EMAILS.includes(user.email)) {
                            videoData.status = "Ignored User";
                            saveToLog(videoData);
                            continue;
                        }

                        // 2. üü¢ CHECK: ALREADY HAS ‚úÖ
                        if (meeting.topic.includes('‚úÖ')) {
                            videoData.status = "Already Marked ‚úÖ";
                            saveToLog(videoData);
                            console.log(`${counter}) üõ°Ô∏è Found ‚úÖ, Auto-saved: "${meeting.topic}"`);
                            continue;
                        }

                        // 3. üü° PREPARE DRIVE CHECK
                        let isSales = false;
                        let salesParentId = null;
                        let brandIds = null;

                        if (SALES_TEAM_FOLDERS[user.email]) {
                            isSales = true;
                            salesParentId = SALES_TEAM_FOLDERS[user.email];
                        } else {
                            if (!meeting.topic.includes(' x ')) {
                                missingList.push(`[BAD NAME] ${meeting.topic}`);
                                continue;
                            }
                            const nameParts = meeting.topic.split(' x ');
                            let brand = nameParts[1].split('-')[0].trim();
                            if (nameParts[1].includes("Scale Session")) brand = nameParts[0].trim();
                            
                            brandIds = getFolderIds(brand);
                            if (!brandIds) {
                                let reverseBrand = nameParts[0].trim();
                                brandIds = getFolderIds(reverseBrand);
                            }
                            if (!brandIds) {
                                missingList.push(`[NO CLICKUP] ${meeting.topic}`);
                                console.log(`${counter}) ‚ùå Brand Not Found: "${meeting.topic}"`);
                                continue;
                            }
                        }

                        // 4. üîç PERFORM DEEP DRIVE VERIFICATION
                        const exists = await verifyInDrive(isSales, meeting.topic, niceDate, salesParentId, brandIds);

                        if (exists) {
                            videoData.status = "Verified in Drive";
                            saveToLog(videoData);
                            await markZoomComplete(meeting.uuid, meeting.topic, token);
                            foundCount++;
                            console.log(`${counter}) ‚úÖ Verified & Saved: "${meeting.topic}"`);
                        } else {
                            missingList.push(`[MISSING FILE] ${meeting.topic} (Date: ${niceDate})`);
                            console.log(`${counter}) ‚ùå Not Found in Drive: "${meeting.topic}"`);
                        }
                    }
                } catch (e) { /* Ignore */ }
            }
        }

        // --- REPORTING ---
        console.log("\n===========================================");
        console.log("üèÅ FULL AUDIT COMPLETE");
        console.log("===========================================");
        console.log(`   üìÖ Range: ${START_DATE_STR} - Today`);
        console.log(`   üî¢ Total In-Range Scanned: ${counter}`);
        console.log(`   ‚úÖ Validated & Saved: ${foundCount}`);
        console.log(`   ‚ùå Missing / Issues: ${missingList.length}`);
        
        fs.writeFileSync(REPORT_PATH, `MISSING VIDEOS REPORT (${new Date().toLocaleString()})\n\n` + missingList.join('\n'));
        console.log(`\nüìÑ Report saved to: missing_report.txt`);

    } catch (error) { console.error("‚ùå Critical Error:", error.message); }
}

syncHistory();
</pre></code>

</body>
</html>
