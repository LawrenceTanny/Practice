<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML Tutorial</title>
</head>
<body>

  <h1>Hi</h1>
  <p>Hello</p>

  <h2>Try</h2>
  <p>
    <a href="https://tannyfolio.pages.dev">
      This is a link I think hehe.
    </a>
  </p>

  <h1>Go to Google Cloud Console,  OAuth 2.0 Client ID then Authorized redirect URIs. paste this. http://localhost:3000/oauth2callback</h1>
    
  <p><strong>FinalDebug.js</strong></p>

  <pre><code>
require('dotenv').config();
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const { google } = require('googleapis');
const querystring = require('querystring');

// --- üõ°Ô∏è CONFIGURATION & IGNORE LISTS ---
const TOKEN_PATH = path.join(__dirname, 'zoom_token.json');

// üõí SALES EQUATION TEAM (Hardcoded Parents)
const SALES_TEAM_FOLDERS = {
    "yoshi@ecommerceequation.com.au": "1i-1JcXYriROX05FJ1vq-Si9p885cYdnh",
    "shant@ecommerceequation.com.au": "1HKQN41WjsOay2oQTPLeDlooZRi0jqRsf",
    "jaket@ecommerceequation.com.au": "1UPVHx1DpeooUi6bnoKwNa0tPPXsWDV9M",
    "seanb@ecommerceequation.com.au": "1PQ_Bm3wkVXYMHPSVhoOb1AoQFQ23JwHS"
};

// üö´ BLACKLIST (Your email removed)
const IGNORE_EMAILS = [
    "finance@ecommerceequation.com.au", "jake@ecommerceequation.com.au",
    "kelsey@ecommerceequation.com.au", "lisa@ecommerceequation.com.au", "bel@ecommerceequation.com.au",
    "emilie@ecommerceequation.com.au", "carlos@ecommerceequation.com.au", "jiah@ecommerceequation.com.au",
    "arthur@ecommerceequation.com.au", "luiza@ecommerceequation.com.au", 
    "andres@ecommerceequation.com.au", "will@ecommerceequation.com.au", "michelles@ecommerceequation.com.au",
    "kimberley@ecommerceequation.com.au", "elizabeth@ecommerceequation.com.au", "ella@ecommerceequation.com.au",
    "kieren@ecommerceequation.com.au", "paige@ecommerceequation.com.au", "thelab@ecommerceequation.com.au",
    "kit@ecommerceequation.com.au", "ernie@ecommerceequation.com.au", "reece@ecommerceequation.com.au",
    "zahrah@ecommerceequation.com.au", "esteban@ecommerceequation.com.au", "mia@ecommerceequation.com.au",
    "admin@ecommerceequation.com.au", "norma@ecommerceequation.com.au", "edel@ecommerceequation.com.au",
    "geralde@ecommerceequation.com.au", "linda@ecommerceequation.com.au", "madisongracewhite@gmail.com",
    "noah@ecommerceequation.com.au", "hayden@ecommerceequation.com.au", "jeff@ecommerceequation.com.au",
    "kingsley@ecommerceequation.com.au", "sooji@ecommerceequation.com.au", "brendan@ecommerceequation.com.au",
    "benjamin@ecommerceequation.com.au", "dan@ecommerceequation.com.au", "michelle@ecommerceequation.com.au",
    "kye@ecommerceequation.com.au", "jasmynn@ecommerceequation.com.au", "neil@ecommerceequation.com.au",
    "nigel@ecommerceequation.com.au", "matt@ecommerceequation.com.au", "theodore@ecommerceequation.com.au",
    "chantel@ecommerceequation.com.au", "kate@ecommerceequation.com.au", "ali@ecommerceequation.com.au",
    "joss@ecommerceequation.com.au", "stevie@ecommerceequation.com.au", "johann@ecommerceequation.com.au",
    "jen@ecommerceequation.com.au"
];

const IGNORE_TOPICS = [
    "Ecommerce Equation", "Ecommerce Equation Zoom", "Accelerate Call", "CUSTOMERS Zoom", "Boardroom"
];

// Global Cache
let FIELD_MAP = { internal: null, member: null };
let CLICKUP_CACHE = []; 

// --- HELPER: DATE FORMATTER ---
function getFormattedDate(dateString) {
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const d = new Date(dateString);
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

// --- 1. EMAIL SENDER (RAW API METHOD - FIXED) ---
async function sendEmailNotification(status, videoName, brand, linkOrReason) {
    if (!process.env.EMAIL_USER) return;
    
    const oauth2Client = new google.auth.OAuth2(
        process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET, "http://localhost:3000/oauth2callback"
    );
    oauth2Client.setCredentials({ refresh_token: process.env.GOOGLE_REFRESH_TOKEN });

    const gmail = google.gmail({ version: 'v1', auth: oauth2Client });
    
    const subject = `[DEBUG TEST] ${status}: ${videoName}`;
    const body = `‚ö†Ô∏è THIS IS A SIMULATION (NO FILES UPLOADED)\n\nVideo: ${videoName}\nBrand: ${brand}\n\nWould be uploaded to: ${linkOrReason}`;
    
    const utf8Subject = `=?utf-8?B?${Buffer.from(subject).toString('base64')}?=`;
    const messageParts = [
        `From: <${process.env.EMAIL_USER}>`,
        `To: <${process.env.EMAIL_USER}>`,
        `Subject: ${utf8Subject}`,
        `MIME-Version: 1.0`,
        `Content-Type: text/plain; charset=utf-8`,
        `Content-Transfer-Encoding: 7bit`,
        ``,
        body
    ];
    const message = messageParts.join('\n');

    const encodedMessage = Buffer.from(message).toString('base64')
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

    try {
        await gmail.users.messages.send({
            userId: 'me',
            requestBody: { raw: encodedMessage },
        });
        console.log(`   üìß [DEBUG] Email notification sent (via Raw API).`);
    } catch (error) {
        console.error("   ‚ùå Failed to send email:", error.message);
    }
}

// --- 2. ZOOM AUTH ---
async function getZoomAccessToken() {
    if (!fs.existsSync(TOKEN_PATH)) throw new Error("‚ùå No Token Found!");
    let tokenData = JSON.parse(fs.readFileSync(TOKEN_PATH));
    if (Date.now() >= tokenData.expires_at) {
        console.log('üîÑ Refreshing Zoom Token...');
        const credentials = Buffer.from(`${process.env.ZOOM_CLIENT_ID}:${process.env.ZOOM_CLIENT_SECRET}`).toString('base64');
        const res = await axios.post('https://zoom.us/oauth/token', 
            querystring.stringify({ grant_type: 'refresh_token', refresh_token: tokenData.refresh_token }),
            { headers: { 'Authorization': `Basic ${credentials}`, 'Content-Type': 'application/x-www-form-urlencoded' } }
        );
        tokenData = { access_token: res.data.access_token, refresh_token: res.data.refresh_token, expires_at: Date.now() + (res.data.expires_in * 1000) - 5000 };
        fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokenData));
    }
    return tokenData.access_token;
}

// --- 3. CLICKUP DEEP SCAN (WITH LOADING BAR) ---
async function refreshClickUpCache() {
    if (!process.env.CLICKUP_LIST_ID || !process.env.CLICKUP_API_KEY) return;
    
    // Get Column IDs
    if (!FIELD_MAP.internal) {
        // console.log("   üîç Mapping Columns...");
        const fieldUrl = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/field`;
        const res = await axios.get(fieldUrl, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
        const iField = res.data.fields.find(f => f.name === process.env.CLICKUP_INTERNAL_COL_NAME);
        const mField = res.data.fields.find(f => f.name === process.env.CLICKUP_MEMBER_COL_NAME);
        if (iField) FIELD_MAP.internal = iField.id;
        if (mField) FIELD_MAP.member = mField.id;
    }

    console.log("   üì• Downloading ClickUp Database (Deep Scan)...");
    let allTasks = [];
    let page = 0;
    let keepGoing = true;

    while (keepGoing) {
        try {
            const url = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true&page=${page}`;
            const res = await axios.get(url, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
            
            if (!res.data.tasks || res.data.tasks.length === 0) {
                keepGoing = false;
            } else {
                allTasks = allTasks.concat(res.data.tasks);
                // LOADING PROGRESS
                process.stdout.write(`      Page ${page} loaded (${res.data.tasks.length} items)...\r`);
                page++;
            }
        } catch (e) {
            console.error("\n   ‚ö†Ô∏è ClickUp Error: " + e.message);
            keepGoing = false;
        }
    }
    console.log(`\n   ‚úÖ ClickUp Cache Updated: ${allTasks.length} Brands loaded in memory.`);
    CLICKUP_CACHE = allTasks;
}

function findFolderLinksInMemory(brandName) {
    const task = CLICKUP_CACHE.find(t => t.name.trim().toLowerCase() === brandName.trim().toLowerCase());
    if (!task) return null;
    const internalVal = task.custom_fields.find(f => f.id === FIELD_MAP.internal)?.value;
    const memberVal = task.custom_fields.find(f => f.id === FIELD_MAP.member)?.value;
    const extractId = (link) => {
        if (!link) return null;
        if (link.includes('id=')) return link.split('id=')[1];
        const parts = link.split('/');
        return parts[parts.length - 1] || parts[parts.length - 2];
    };
    return { internalFolderId: extractId(internalVal), memberFolderId: extractId(memberVal) };
}

// --- 5. THE DEBUG LOOP ---
async function checkZoomDebug() {
    try {
        console.log(`\nüïí DEBUG SIMULATION (NO UPLOADS): ${new Date().toLocaleTimeString()}`);
        
        // 1. LOADING: Download database first
        await refreshClickUpCache(); 
        const token = await getZoomAccessToken();

        // üü¢ DEBUG: Check ONLY Today
        const today = new Date().toISOString().split('T')[0];
        console.log(`   üîé Scanning ALL Recordings for TODAY: ${today}`);

        const usersRes = await axios.get('https://api.zoom.us/v2/users?page_size=300', { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        const users = usersRes.data.users || [];
        console.log(`   üë• Scanning ${users.length} users...`);

        for (const user of users) {
            if (IGNORE_EMAILS.includes(user.email)) continue;

            try {
                const url = `https://api.zoom.us/v2/users/${user.id}/recordings?from=${today}&to=${today}`;
                const res = await axios.get(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!res.data.meetings || res.data.meetings.length === 0) continue;

                for (const meeting of res.data.meetings) {
                    
                    if (IGNORE_TOPICS.some(ignored => meeting.topic.includes(ignored))) continue;

                    let links = null;
                    let brand = "";
                    let isSalesEquation = false;
                    let destinationNote = "";
                    let parentLink = "";

                    // ------------------------------------------------------------------
                    // üõ£Ô∏è PATH 1: SALES EQUATION
                    // ------------------------------------------------------------------
                    if (SALES_TEAM_FOLDERS[user.email]) {
                        if (!meeting.topic.includes(' x ')) {
                            console.log(`      ‚ö†Ô∏è  Skipping "${meeting.topic}" (Sales User but No 'x')`);
                            continue;
                        }
                        
                        console.log(`\n   üü£ SALES EQUATION FOUND: "${meeting.topic}" (User: ${user.first_name})`);
                        
                        const parentId = SALES_TEAM_FOLDERS[user.email];
                        links = { internalFolderId: "SIMULATED_ID", memberFolderId: "SIMULATED_ID" };
                        isSalesEquation = true;
                        brand = "Sales Equation"; 
                        destinationNote = `[New Subfolder: "${meeting.topic}"]`;
                        parentLink = `https://drive.google.com/drive/folders/${parentId}`;
                    } 
                    // ------------------------------------------------------------------
                    // üõ£Ô∏è PATH 2: STANDARD UPLOADS
                    // ------------------------------------------------------------------
                    else {
                        const nameParts = meeting.topic.split(' x ');
                        if (nameParts.length < 2) continue; 

                        brand = nameParts[1].split('-')[0].trim();
                        if (nameParts[1].includes("Scale Session")) brand = nameParts[0].trim();

                        console.log(`\n   üîµ STANDARD VIDEO FOUND: "${meeting.topic}" (User: ${user.first_name})`);
                        links = findFolderLinksInMemory(brand);
                        destinationNote = "";
                    }

                    if (!links || !links.internalFolderId) {
                        console.log(`      ‚ùå Brand "${brand}" missing details.`);
                        continue;
                    }

                    // ------------------------------------------------------------------
                    // üìù SIMULATE UPLOAD
                    // ------------------------------------------------------------------
                    for (const file of meeting.recording_files) {
                        if (file.file_type !== 'MP4' && file.file_type !== 'M4A') continue;
                        const fileExt = file.file_type === 'MP4' ? '.mp4' : '.m4a';

                        // üìõ RENAMING LOGIC
                        let finalFileName = `${meeting.topic.replace(/[^a-zA-Z0-9]/g, '_')}${fileExt}`;
                        if (isSalesEquation && file.file_type === 'MP4') {
                            const niceDate = getFormattedDate(meeting.start_time);
                            finalFileName = `${meeting.topic} - ${niceDate}${fileExt}`; 
                        }

                        // Determine Target ID
                        let targetFolderId = links.memberFolderId; 
                        let targetType = "Member Link";
                        if (file.file_type === 'MP4') {
                            targetFolderId = links.internalFolderId;
                            targetType = "Internal Link";
                        }
                        if (user.email === 'travis@ecommerceequation.com.au') {
                            targetFolderId = links.internalFolderId;
                            targetType = "Internal Link (Travis Force)";
                        }

                        // üîó GENERATE REAL DISPLAY LINK
                        let displayLink = "";
                        if (isSalesEquation) {
                            displayLink = `${parentLink} (Subfolder will be created here)`;
                        } else {
                            displayLink = `https://drive.google.com/drive/folders/${targetFolderId}`;
                        }

                        // üñ®Ô∏è THE REQUESTED OUTPUT
                        console.log(`      üìÑ ${meeting.topic} (${file.file_type}) -> Renamed to: "${finalFileName}"`);
                        console.log(`         ‚Ü≥ is uploaded to ${targetType}: ${displayLink} ${destinationNote}`);

                        // Send Email (MP4 Only)
                        if (file.file_type === 'MP4') {
                            await sendEmailNotification('SUCCESS', finalFileName, brand, displayLink);
                        }
                    }
                }
            } catch (err) { /* Ignore user errors */ }
        }
        console.log("\n‚úÖ DEBUG SCAN COMPLETE.\n");

    } catch (error) {
        console.error("‚ùå Watchman Error:", error.message);
    }
}

checkZoomDebug();
  </code></pre>



</body>
</html>
