<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML Tutorial</title>
</head>
<body>

  <h1>Hi</h1>
  <p>Hello</p>

  <h2>Try</h2>
  <p>
    <a href="https://tannyfolio.pages.dev">
      This is a link I think hehe.
    </a>
  </p>

  <h1>Add Scope: user:read:admin</h1>
  <p><strong>Server.js</strong></p>

  This is Latest code.
  
  <pre><code>
require('dotenv').config();
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const { google } = require('googleapis');
const querystring = require('querystring');
const nodemailer = require('nodemailer');

// --- CONFIGURATION ---
const CHECK_INTERVAL_MINUTES = 15;
const TOKEN_PATH = path.join(__dirname, 'zoom_token.json');
const LOG_PATH = path.join(__dirname, 'completed_log.json');

// Global Cache
let FIELD_MAP = { internal: null, member: null };
let CLICKUP_CACHE = []; // Stores all brands from all pages

// --- 1. EMAIL SENDER ---
async function sendEmailNotification(status, videoName, brand, linkOrReason) {
    try {
        if (!process.env.EMAIL_USER) return;
        const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                type: 'OAuth2',
                user: process.env.EMAIL_USER,
                clientId: process.env.GOOGLE_CLIENT_ID,
                clientSecret: process.env.GOOGLE_CLIENT_SECRET,
                refreshToken: process.env.GOOGLE_REFRESH_TOKEN
            }
        });

        const subject = status === 'SUCCESS' ? `‚úÖ Upload Success: ${videoName}` : `‚ùå Upload Failed: ${videoName}`;
        const text = status === 'SUCCESS'
            ? `Video: ${videoName}\nBrand: ${brand}\n\nSuccessfully uploaded to Drive!\nView here: ${linkOrReason}`
            : `Video: ${videoName}\nBrand: ${brand}\n\nFailed to upload.\nReason: ${linkOrReason}`;

        await transporter.sendMail({ from: process.env.EMAIL_USER, to: process.env.EMAIL_USER, subject, text });
        console.log(`   üìß Email notification sent.`);
    } catch (error) {
        console.error("   ‚ùå Failed to send email:", error.message);
    }
}

// --- 2. ZOOM AUTH ---
async function getZoomAccessToken() {
    if (!fs.existsSync(TOKEN_PATH)) throw new Error("‚ùå No Token Found!");
    let tokenData = JSON.parse(fs.readFileSync(TOKEN_PATH));
    if (Date.now() >= tokenData.expires_at) {
        console.log('üîÑ Refreshing Zoom Token...');
        const credentials = Buffer.from(`${process.env.ZOOM_CLIENT_ID}:${process.env.ZOOM_CLIENT_SECRET}`).toString('base64');
        const res = await axios.post('https://zoom.us/oauth/token', 
            querystring.stringify({ grant_type: 'refresh_token', refresh_token: tokenData.refresh_token }),
            { headers: { 'Authorization': `Basic ${credentials}`, 'Content-Type': 'application/x-www-form-urlencoded' } }
        );
        tokenData = { access_token: res.data.access_token, refresh_token: res.data.refresh_token, expires_at: Date.now() + (res.data.expires_in * 1000) - 5000 };
        fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokenData));
    }
    return tokenData.access_token;
}

// --- 3. CLICKUP DEEP SCAN (The Fix) ---
async function refreshClickUpCache() {
    if (!process.env.CLICKUP_LIST_ID || !process.env.CLICKUP_API_KEY) return;
    
    // 1. Get Column IDs once
    if (!FIELD_MAP.internal) {
        // console.log("   üîç Mapping Columns...");
        const fieldUrl = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/field`;
        const res = await axios.get(fieldUrl, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
        const iField = res.data.fields.find(f => f.name === process.env.CLICKUP_INTERNAL_COL_NAME);
        const mField = res.data.fields.find(f => f.name === process.env.CLICKUP_MEMBER_COL_NAME);
        if (iField) FIELD_MAP.internal = iField.id;
        if (mField) FIELD_MAP.member = mField.id;
    }

    // 2. Download ALL Pages
    console.log("   üì• Downloading ClickUp Database (Deep Scan)...");
    let allTasks = [];
    let page = 0;
    let keepGoing = true;

    while (keepGoing) {
        try {
            const url = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true&page=${page}`;
            const res = await axios.get(url, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
            
            if (!res.data.tasks || res.data.tasks.length === 0) {
                keepGoing = false;
            } else {
                allTasks = allTasks.concat(res.data.tasks);
                // Optional: Print dots to show progress
                // process.stdout.write('.'); 
                page++;
            }
        } catch (e) {
            console.error("   ‚ö†Ô∏è ClickUp Scan Error (Page " + page + "): " + e.message);
            keepGoing = false;
        }
    }
    console.log(`   ‚úÖ Cache Updated: ${allTasks.length} Brands loaded in memory.`);
    CLICKUP_CACHE = allTasks;
}

function findFolderLinksInMemory(brandName) {
    // üõ†Ô∏è DEBUG TEST MODE
    if (brandName.toUpperCase().includes('SYOTI')) {
        return { 
            internalFolderId: "19hksGePp4XPpiTpYES-ogcj8Fx0fFszX", 
            memberFolderId: "1FoSkvhk-j8Mb0mrOKf8MA0xhU81jjRsr" 
        };
    }

    const task = CLICKUP_CACHE.find(t => t.name.trim().toLowerCase() === brandName.trim().toLowerCase());
    if (!task) return null;

    const internalVal = task.custom_fields.find(f => f.id === FIELD_MAP.internal)?.value;
    const memberVal = task.custom_fields.find(f => f.id === FIELD_MAP.member)?.value;

    const extractId = (link) => {
        if (!link) return null;
        if (link.includes('id=')) return link.split('id=')[1];
        const parts = link.split('/');
        return parts[parts.length - 1] || parts[parts.length - 2];
    };

    return { internalFolderId: extractId(internalVal), memberFolderId: extractId(memberVal) };
}

// --- 4. GOOGLE UPLOAD ---
async function uploadToDrive(filePath, fileName, folderId) {
    const oauth2Client = new google.auth.OAuth2(
        process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET, "http://localhost"
    );
    oauth2Client.setCredentials({ refresh_token: process.env.GOOGLE_REFRESH_TOKEN });
    const drive = google.drive({ version: 'v3', auth: oauth2Client });

    const fileMetadata = { name: fileName, parents: [folderId] };
    const media = { mimeType: 'video/mp4', body: fs.createReadStream(filePath) };

    const res = await drive.files.create({ resource: fileMetadata, media: media, fields: 'id, webViewLink' });
    return res.data;
}

// --- 5. THE WATCHMAN LOOP ---
async function checkZoom() {
    try {
        console.log(`\nüïí Watchman Scan: ${new Date().toLocaleTimeString()}`);
        
        // STEP 1: Update the Cache (Heavy Lifting)
        await refreshClickUpCache();
        
        // STEP 2: Check Zoom
        const token = await getZoomAccessToken();
        let completed = [];
        if (fs.existsSync(LOG_PATH)) completed = JSON.parse(fs.readFileSync(LOG_PATH));

        // Time Window: Last 7 Days
        const d = new Date();
        const toDate = d.toISOString().split('T')[0];
        d.setDate(d.getDate() - 7); 
        const fromDate = d.toISOString().split('T')[0];

        // Get All Employees
        const usersRes = await axios.get('https://api.zoom.us/v2/users?page_size=300', { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        const users = usersRes.data.users || [];
        console.log(`   üë• Scanning ${users.length} users (from ${fromDate} to ${toDate})...`);

        for (const user of users) {
            try {
                const res = await axios.get(`https://api.zoom.us/v2/users/${user.id}/recordings?from=${fromDate}&to=${toDate}`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });

                if (!res.data.meetings || res.data.meetings.length === 0) continue;

                for (const meeting of res.data.meetings) {
                    if (completed.includes(meeting.uuid)) continue;

                    const nameParts = meeting.topic.split(' x ');
                    if (nameParts.length < 2) {
                        console.log(`      ‚ö†Ô∏è Ignoring "${meeting.topic}"`);
                        continue; 
                    }

                    let brand = nameParts[1].split('-')[0].trim();
                    console.log(`   üöÄ New Video: "${meeting.topic}" (User: ${user.first_name})`);

                    // STEP 3: Check Memory (Instant)
                    const links = findFolderLinksInMemory(brand);
                    
                    if (!links || !links.internalFolderId) {
                        console.log(`      ‚ùå Brand "${brand}" missing details in ClickUp.`);
                        await sendEmailNotification('FAIL', meeting.topic, brand, "Brand not found in ClickUp.");
                        continue;
                    }

                    console.log(`      ‚úÖ Destination Found! Downloading...`);

                    for (const file of meeting.recording_files) {
                        if (file.file_type !== 'MP4' && file.file_type !== 'M4A') continue;

                        const downloadUrl = `${file.download_url}?access_token=${token}`;
                        const fileExt = file.file_type === 'MP4' ? '.mp4' : '.m4a';
                        const tempName = `${meeting.topic.replace(/[^a-zA-Z0-9]/g, '_')}${fileExt}`;
                        const tempPath = path.join(__dirname, tempName);

                        try {
                            const writer = fs.createWriteStream(tempPath);
                            const streamRes = await axios({ url: downloadUrl, method: 'GET', responseType: 'stream' });
                            streamRes.data.pipe(writer);

                            await new Promise((resolve, reject) => {
                                writer.on('finish', resolve);
                                writer.on('error', reject);
                            });

                            let targetFolder = links.memberFolderId;
                            if (file.file_type === 'MP4') targetFolder = links.internalFolderId;

                            if (targetFolder) {
                                console.log(`      üì§ Uploading to Drive...`);
                                const uploadData = await uploadToDrive(tempPath, tempName, targetFolder);
                                if (file.file_type === 'MP4') {
                                     await sendEmailNotification('SUCCESS', meeting.topic, brand, `https://drive.google.com/file/d/${uploadData.id}/view`);
                                }
                                console.log(`      üéâ Upload Complete!`);
                            }

                        } catch (err) {
                            console.error(`      ‚ùå Error: ${err.message}`);
                            await sendEmailNotification('FAIL', meeting.topic, brand, err.message);
                        } finally {
                            if (fs.existsSync(tempPath)) fs.unlinkSync(tempPath); 
                        }
                    }

                    completed.push(meeting.uuid);
                    fs.writeFileSync(LOG_PATH, JSON.stringify(completed, null, 2));
                }
            } catch (err) { /* Ignore user errors */ }
        }

    } catch (error) {
        console.error("‚ùå Watchman Error:", error.message);
    }
}

checkZoom();
setInterval(checkZoom, CHECK_INTERVAL_MINUTES * 60 * 1000);
  </code></pre>






    <p><strong>Check_Clickup.js</strong></p>

  <pre><code>
    require('dotenv').config();
const axios = require('axios');

async function inspectClickUp() {
    console.log("üïµÔ∏è Connecting to ClickUp (Deep Scan Mode)...");

    if (!process.env.CLICKUP_API_KEY || !process.env.CLICKUP_LIST_ID) {
        return console.error("‚ùå Error: Missing API Key or List ID in .env file.");
    }

    try {
        // 1. GET COLUMN IDs
        console.log("   üîç Mapping Columns...");
        const fieldUrl = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/field`;
        const fieldRes = await axios.get(fieldUrl, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
        
        const internalField = fieldRes.data.fields.find(f => f.name === process.env.CLICKUP_INTERNAL_COL_NAME);
        const memberField = fieldRes.data.fields.find(f => f.name === process.env.CLICKUP_MEMBER_COL_NAME);

        if (!internalField || !memberField) {
            console.log("\n‚ùå ERROR: Could not find your specific columns!");
            return;
        }
        console.log("   ‚úÖ Columns Found!");

        // 2. FETCH ALL TASKS (Looping Pages + Subtasks)
        console.log("\n   üì• Downloading ALL tasks (This may take a moment)...");
        
        let allTasks = [];
        let page = 0;
        let keepGoing = true;

        while (keepGoing) {
            // Added 'subtasks=true' and 'page=X'
            const taskUrl = `https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true&page=${page}`;
            const res = await axios.get(taskUrl, { headers: { 'Authorization': process.env.CLICKUP_API_KEY } });
            
            const tasks = res.data.tasks;
            if (tasks.length === 0) {
                keepGoing = false;
            } else {
                allTasks = allTasks.concat(tasks);
                process.stdout.write(`      Page ${page} loaded (${tasks.length} items)... \r`);
                page++;
            }
        }

        console.log(`\n\n   üìù RESULTS (${allTasks.length} Total Brands Found):`);
        console.log("   ===================================================");

        allTasks.forEach((task, index) => {
            const internalVal = task.custom_fields.find(f => f.id === internalField.id)?.value;
            const memberVal = task.custom_fields.find(f => f.id === memberField.id)?.value;

            console.log(`   ${index + 1}. Brand:    ${task.name}`);
            if (internalVal || memberVal) {
                 console.log(`      ‚úÖ Links Detected`);
            } else {
                 console.log(`      ‚ö†Ô∏è  No Links (Check ClickUp)`);
            }
            // console.log("   ---------------------------------------------------"); 
        });

        console.log(`\n‚úÖ Scan Complete. Total Brands: ${allTasks.length}`);

    } catch (error) {
        console.error("‚ùå Error:", error.response ? error.response.data : error.message);
    }
}

inspectClickUp();
  </code></pre>
</body>
</html>
